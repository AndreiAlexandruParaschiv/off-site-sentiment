const fs = require('fs');

function generateMarkdownReport(data, outputPath) {
  const { searchTerm, timestamp, results, summary } = data;
  
  // Calculate statistics
  const successful = results.filter(r => r.status === 'success' && r.sentiment);
  
  let avgScore = 0;
  let avgComparative = 0;
  let positive = 0;
  let negative = 0;
  let neutral = 0;
  
  if (successful.length > 0) {
    avgScore = successful.reduce((sum, r) => sum + r.sentiment.score, 0) / successful.length;
    avgComparative = successful.reduce((sum, r) => sum + r.sentiment.comparative, 0) / successful.length;
    positive = successful.filter(r => r.classification === 'positive').length;
    negative = successful.filter(r => r.classification === 'negative').length;
    neutral = successful.filter(r => r.classification === 'neutral').length;
  }
  
  const positivePercent = successful.length > 0 ? (positive / successful.length * 100).toFixed(1) : 0;
  const neutralPercent = successful.length > 0 ? (neutral / successful.length * 100).toFixed(1) : 0;
  const negativePercent = successful.length > 0 ? (negative / successful.length * 100).toFixed(1) : 0;
  
  // Generate markdown content
  let markdown = `# Backlink Sentiment Analysis Report

**Brand:** ${searchTerm}  
**Generated:** ${new Date(timestamp).toLocaleString()}

---

## Summary Statistics

- **Total URLs Processed:** ${summary.total}
- **Successfully Analyzed:** ${summary.successful}
- **Pages with Brand Mentions:** ${summary.withMentions}
- **Errors:** ${summary.errors}
- **Average Sentiment Score:** ${avgScore.toFixed(2)}
- **Average Comparative Score:** ${avgComparative.toFixed(4)}

### Sentiment Distribution

- **Positive:** ${positive} URLs (${positivePercent}%)
- **Neutral:** ${neutral} URLs (${neutralPercent}%)
- **Negative:** ${negative} URLs (${negativePercent}%)

---

## Detailed Results

| URL | Sentiment | Brand Mention | Rationale | Excerpt |
|-----|-----------|---------------|-----------|---------|
`;
  
  // Add each result as a table row (skip errors)
  results.forEach((result) => {
    // Skip error results
    if (result.status === 'error') {
      return;
    }
    
    const url = escapeMarkdown(result.url);
    const sentiment = result.classification || '-';
    
    // Brand mention with count
    let brandMention = 'No';
    if (result.mentionsBrand && result.mentionCount > 0) {
      brandMention = `Yes (${result.mentionCount}x)`;
    } else if (result.mentionsBrand) {
      brandMention = 'Yes';
    }
    
    const rationale = result.rationale ? escapeMarkdown(result.rationale) : '-';
    
    // For excerpt, show the longest/best context where brand is mentioned
    let excerpt = '-';
    if (result.excerpts && result.excerpts.length > 0) {
      // Find the longest excerpt (usually has the most context)
      const bestExcerpt = result.excerpts.reduce((longest, current) => 
        current.length > longest.length ? current : longest
      );
      // Clean it up and show full context (up to 300 chars)
      excerpt = escapeMarkdown(bestExcerpt.substring(0, 300).trim());
      if (bestExcerpt.length > 300) excerpt += '...';
    }
    
    markdown += `| ${url} | ${sentiment} | ${brandMention} | ${rationale} | ${excerpt} |\n`;
  });
  
  markdown += `\n---

## Legend

**Sentiment:**
- \`positive\` - Positive sentiment (score > 0)
- \`neutral\` - Neutral sentiment (score = 0)
- \`negative\` - Negative sentiment (score < 0)

---

*Report generated by Backlink Sentiment Analyzer*
`;
  
  // Write to file
  fs.writeFileSync(outputPath, markdown, 'utf8');
}

// Helper function to escape markdown special characters
function escapeMarkdown(text) {
  if (!text) return '';
  return text
    .replace(/\|/g, '\\|')
    .replace(/\n/g, ' ')
    .replace(/\r/g, '')
    .trim();
}

// Helper function to truncate text
function truncate(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

module.exports = { generateMarkdownReport };

